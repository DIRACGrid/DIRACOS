variables:
    EOS_PATH: "/eos/project/d/diracos/www/"
    GIT_SUBMODULE_STRATEGY: recursive

stages:
    - compile
    - links
    - test
    - deploy

compile:
  stage: compile
  retry: 2
  tags:
    - DIRACOS
  image: cern/slc6-base
  script:
    - yum install -y mock rpm-build fedora-packager createrepo python-pip
    - export DIRACOS_REPO=/diracos_repo
    - mkdir -p $DIRACOS_REPO/i386 $DIRACOS_REPO/i686 $DIRACOS_REPO/src $DIRACOS_REPO/noarch $DIRACOS_REPO/x86_64 $DIRACOS_REPO/bootstrap $DIRACOS_REPO/buildOnly
    - curl -o $DIRACOS_REPO/bootstrap/lbzip2-2.5-2.el6.x86_64.rpm -L https://diracos.web.cern.ch/diracos/bootstrap/lbzip2-2.5-2.el6.x86_64.rpm
    - curl -o $DIRACOS_REPO/bootstrap/pigz-2.3.4-1.el6.x86_64.rpm -L https://diracos.web.cern.ch/diracos/bootstrap/pigz-2.3.4-1.el6.x86_64.rpm
    - createrepo $DIRACOS_REPO
    - pip install git+${CI_REPOSITORY_URL}@${CI_COMMIT_REF_NAME}
    - sed -i -e 's/-j4/-j16/g' mockConfigs/mock-build-diracos.cfg
    - dos-build-all-rpms config/diracos.json
    - dos-fix-pip-versions config/diracos.json
    - mkdir -p public/${CI_COMMIT_REF_NAME}
    - cp /var/lib/mock/epel-6-x86_64-install/root/tmp/fixed_requirements.txt public/${CI_COMMIT_REF_NAME}/.
    - dos-build-python-modules config/diracos.json
    - dos-bundle config/diracos.json
    - cp /var/lib/mock/epel-6-x86_64-install/root/tmp/diracos-${CI_COMMIT_REF_NAME}.tar.gz public/${CI_COMMIT_REF_NAME}/diracos-${CI_COMMIT_REF_NAME}.tar.gz
    - cd public/${CI_COMMIT_REF_NAME}
    - md5sum diracos-${CI_COMMIT_REF_NAME}.tar.gz | awk {'print $1'} > diracos-${CI_COMMIT_REF_NAME}.md5
  artifacts:
    paths:
      - public
    expire_in: 1 week


# Check links
check_links:
  stage: links
  tags:
    - docker
  image: cern/slc6-base
  before_script:
    - yum install tar -y
  script:
    - tar xf public/${CI_COMMIT_REF_NAME}/diracos-${CI_COMMIT_REF_NAME}.tar.gz -C /tmp
    - export DIRACOS=/tmp/diracos
    - source $DIRACOS/diracosrc
    - ./tests/integration/test_symlink.sh
  dependencies:
    - compile


# Run tests

.run_test:
  stage: test
  tags:
    - docker
  script:
    - tar xf public/${CI_COMMIT_REF_NAME}/diracos-${CI_COMMIT_REF_NAME}.tar.gz -C /tmp
    - export DIRACOS=/tmp/diracos
    - source $DIRACOS/diracosrc
    - pytest tests/integration/test_import.py
    - tests/integration/test_cli.sh
  dependencies:
    - compile

SLC6:
  extends: .run_test
  image: cern/slc6-base
  before_script:
    - yum install tar -y

CC7:
  extends: .run_test
  image: cern/cc7-base

fedora-latest:
  extends: .run_test
  image: fedora:latest
  allow_failure: true
  variables:
    LD_PRELOAD: "/lib64/libselinux.so.1"

ubuntu-latest:
  extends: .run_test
  image: ubuntu:latest
  allow_failure: true


# Deploy to EOS folder
deployment:
    stage: deploy
    only:
      - tags@CLICdp/iLCDirac/DIRACOS
      - branches@CLICdp/iLCDirac/DIRACOS
    # Custom docker image providing the needed tools to deploy in EOS
    image: gitlab-registry.cern.ch/ci-tools/ci-web-deployer:latest
    script:
        - deploy-eos
    # do not run any globally defined before_script or after_script for this step
    before_script: []
    after_script: []
